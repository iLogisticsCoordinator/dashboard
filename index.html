<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Lector PDA - Visualización Completa</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #000;
      color: #0f0;
      touch-action: manipulation;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
      overflow: hidden;
      position: fixed;
      width: 100%;
      height: 100%;
    }
    #scanner {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    #barcode {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      text-align: center;
      background: #111;
      color: #0f0;
      border: none;
      border-bottom: 2px solid #0f0;
    }
    #status {
      padding: 10px;
      text-align: center;
      background: #222;
      font-size: 16px;
    }
    #results {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
      -webkit-overflow-scrolling: touch;
    }
    .result-item {
      margin-bottom: 15px;
      padding: 10px;
      background: #111;
      border-left: 3px solid #0f0;
    }
    .result-row {
      display: flex;
      margin-bottom: 5px;
    }
    .col-header {
      min-width: 120px;
      font-weight: bold;
      color: #4CAF50;
    }
    .error {
      color: #f00;
      text-align: center;
      padding: 15px;
    }
    .data-stats {
      text-align: center;
      padding: 5px;
      color: #666;
      font-size: 14px;
      background: #222;
    }
    .loading {
      color: #ff0;
      text-align: center;
      padding: 15px;
    }
    .offline-banner {
      background: #f80;
      color: #000;
      text-align: center;
      padding: 5px;
      font-size: 12px;
    }
    .siesa-item {
      margin-top: 10px;
      padding: 8px;
      background: #222;
      border-left: 2px solid #0ff;
    }
    .siesa-header {
      font-weight: bold;
      color: #0ff;
      margin-bottom: 5px;
      border-bottom: 1px solid #333;
      padding-bottom: 3px;
    }
    .json-value {
      word-break: break-all;
    }
    .no-data {
      color: #888;
      font-style: italic;
    }
    #fullscreen-btn {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #333;
      color: #0f0;
      border: 1px solid #0f0;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 20px;
      z-index: 1000;
      display: none;
    }
  </style>
</head>
<body>
  <div id="scanner">
    <div id="offline-banner" class="offline-banner" style="display: none;">MODO OFFLINE - DATOS CACHEADOS</div>
    <input type="text" id="barcode" autofocus placeholder="ESCANEAR CÓDIGO">
    <div id="status">INICIANDO SISTEMA...</div>
    <div class="data-stats" id="data-stats">Cargando datos...</div>
    <div id="results"></div>
  </div>
  <button id="fullscreen-btn" title="Pantalla completa">⛶</button>

  <script>
    // Configuración
    const CONFIG = {
      API_URL: "https://script.google.com/macros/s/AKfycbzf013uqUkPD62derU15nq-nXOYI6Y8KNi-e7Upnj6lOzoTOoGyT4XwAaDxHbpgLJWS_Q/exec",
      CACHE_TTL: 24 * 60 * 60 * 1000, // 24 horas en milisegundos
      VERSION: "2.2.0"
    };

    // Variables globales
    let database = [];
    const barcodeInput = document.getElementById('barcode');
    const statusDiv = document.getElementById('status');
    const resultsDiv = document.getElementById('results');
    const dataStats = document.getElementById('data-stats');
    const offlineBanner = document.getElementById('offline-banner');
    const fullscreenBtn = document.getElementById('fullscreen-btn');

    // Iniciar aplicación
    document.addEventListener('DOMContentLoaded', () => {
      setupFullscreen();
      const cachedData = getCachedData();
      
      if (cachedData) {
        database = cachedData.data;
        updateUIWithCachedData(cachedData);
        
        if (!navigator.onLine) {
          offlineBanner.style.display = 'block';
        }
      }
      
      if (navigator.onLine) {
        fetchData();
      } else {
        statusDiv.textContent = "MODO OFFLINE - USANDO DATOS CACHEADOS";
      }
      
      setupEventListeners();
      setupDataRefresh();
    });

    // Funciones de pantalla completa
    function setupFullscreen() {
      // Mostrar botón solo en dispositivos móviles
      if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        fullscreenBtn.style.display = 'block';
        fullscreenBtn.addEventListener('click', toggleFullscreen);
      }
      
      // Detectar cambios en el estado de pantalla completa
      document.addEventListener('fullscreenchange', handleFullscreenChange);
      document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
      document.addEventListener('mozfullscreenchange', handleFullscreenChange);
      document.addEventListener('MSFullscreenChange', handleFullscreenChange);
    }

    function toggleFullscreen() {
      if (!document.fullscreenElement && !document.webkitFullscreenElement &&
          !document.mozFullScreenElement && !document.msFullscreenElement) {
        enterFullscreen();
      } else {
        exitFullscreen();
      }
    }

    function enterFullscreen() {
      const elem = document.documentElement;
      
      if (elem.requestFullscreen) {
        elem.requestFullscreen();
      } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
      } else if (elem.mozRequestFullScreen) {
        elem.mozRequestFullScreen();
      } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
      }
      
      // Ocultar la barra de dirección en Android Chrome
      if (window.navigator.standalone === true || 
          (window.matchMedia('(display-mode: standalone)').matches) {
        // Ya está en modo PWA
      } else {
        setTimeout(() => {
          window.scrollTo(0, 1);
        }, 100);
      }
    }

    function exitFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.mozCancelFullScreen) {
        document.mozCancelFullScreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }

    function handleFullscreenChange() {
      if (document.fullscreenElement || document.webkitFullscreenElement ||
          document.mozFullScreenElement || document.msFullscreenElement) {
        fullscreenBtn.textContent = '⛶';
      } else {
        fullscreenBtn.textContent = '⛶';
      }
    }

    // Funciones principales
    function getCachedData() {
      const cache = localStorage.getItem('pdaScannerCache');
      if (!cache) return null;
      
      try {
        const parsed = JSON.parse(cache);
        if (Date.now() - parsed.timestamp > CONFIG.CACHE_TTL) return null;
        return parsed;
      } catch (e) {
        console.error("Error al parsear cache:", e);
        return null;
      }
    }

    async function fetchData() {
      statusDiv.textContent = "ACTUALIZANDO DATOS...";
      dataStats.textContent = "Conectando con el servidor...";
      
      try {
        const response = await fetch(CONFIG.API_URL + '?t=' + Date.now());
        if (!response.ok) throw new Error('Error en la respuesta del servidor');
        
        const apiData = await response.json();
        
        if (!apiData.success) {
          throw new Error('La API reportó un error');
        }
        
        if (!apiData.data || !Array.isArray(apiData.data)) {
          throw new Error('Formato de datos desconocido');
        }
        
        database = apiData.data;
        cacheData(database);
        
        statusDiv.textContent = "SISTEMA ACTUALIZADO Y LISTO";
        dataStats.textContent = `${database.length} registros cargados (${new Date().toLocaleTimeString()})`;
        resultsDiv.innerHTML = '<div class="loading">Escanea un código para comenzar</div>';
        offlineBanner.style.display = 'none';
      } catch (error) {
        console.error("Error al actualizar datos:", error);
        
        if (database.length === 0) {
          statusDiv.innerHTML = '<span class="error">ERROR AL CARGAR DATOS</span>';
          dataStats.textContent = error.message;
          resultsDiv.innerHTML = `<div class="error">No se pudo cargar la base de datos: ${error.message}</div>`;
        } else {
          statusDiv.textContent = "SISTEMA LISTO (DATOS NO ACTUALIZADOS)";
          dataStats.textContent = `${database.length} registros (versión cacheada)`;
          offlineBanner.style.display = 'block';
        }
      }
    }

    function setupEventListeners() {
      // Foco persistente
      function enforceFocus() {
        if (document.activeElement !== barcodeInput) {
          barcodeInput.focus();
        }
        setTimeout(enforceFocus, 50);
      }
      enforceFocus();
      
      // Detectar escaneo
      barcodeInput.addEventListener('input', function() {
        const code = this.value.trim();
        if (code.length < 3) return;
        
        const startTime = Date.now();
        const result = database.find(item => item.columnaA && item.columnaA.toString() === code);
        const searchTime = Date.now() - startTime;
        
        if (result) {
          displayFullResult(result);
          playBeep(true);
          statusDiv.textContent = `REGISTRO ENCONTRADO (${searchTime}ms)`;
        } else {
          showError(code);
          playBeep(false);
          statusDiv.textContent = `NO ENCONTRADO (${searchTime}ms)`;
        }
        
        setTimeout(() => {
          this.value = '';
          this.focus();
        }, 50);
      });
      
      // Manejar cambios en la conexión
      window.addEventListener('online', () => {
        fetchData();
        offlineBanner.style.display = 'none';
      });
      
      window.addEventListener('offline', () => {
        offlineBanner.style.display = 'block';
        statusDiv.textContent = "MODO OFFLINE - USANDO DATOS CACHEADOS";
      });
      
      // Forzar pantalla completa al tocar cualquier parte de la pantalla
      document.addEventListener('click', () => {
        if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
          enterFullscreen();
        }
      });
    }

    function displayFullResult(item) {
      resultsDiv.innerHTML = `
        <div class="result-item">
          ${displayItemData(item, 'Datos Principales')}
        </div>
      `;
      
      // Desplazar hacia arriba para mejor visibilidad
      resultsDiv.scrollTop = 0;
    }

    function displayItemData(data, title = 'Datos') {
      let html = `<div class="siesa-header">${title}</div>`;
      
      // Mostrar propiedades directas del objeto
      for (const key in data) {
        if (key === 'datosSiesa') continue; // Manejamos esto aparte
        
        html += `
          <div class="result-row">
            <div class="col-header">${key}:</div>
            <div class="json-value">${formatValue(data[key])}</div>
          </div>
        `;
      }
      
      // Mostrar datosSiesa si existen
      if (data.datosSiesa && Array.isArray(data.datosSiesa) && data.datosSiesa.length > 0) {
        html += `<div class="siesa-header">Documentos Siesa (${data.datosSiesa.length})</div>`;
        
        data.datosSiesa.forEach((siesa, index) => {
          html += `<div class="siesa-item">`;
          html += `<div class="siesa-header">Documento #${index + 1}</div>`;
          
          for (const key in siesa) {
            html += `
              <div class="result-row">
                <div class="col-header">${key}:</div>
                <div class="json-value">${formatValue(siesa[key])}</div>
              </div>
            `;
          }
          
          html += `</div>`;
        });
      }
      
      return html;
    }

    function formatValue(value) {
      if (value === null || value === undefined) {
        return '<span class="no-data">N/A</span>';
      }
      
      if (typeof value === 'object') {
        return JSON.stringify(value);
      }
      
      if (typeof value === 'number' && value > 1000) {
        return value.toLocaleString();
      }
      
      return value.toString();
    }

    function showError(barcode) {
      resultsDiv.innerHTML = `
        <div class="error">
          CÓDIGO NO ENCONTRADO: ${barcode}
        </div>
      `;
    }

    function playBeep(success) {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctx.createOscillator();
        osc.type = "square";
        osc.frequency.value = success ? 800 : 400;
        osc.connect(ctx.destination);
        osc.start();
        osc.stop(ctx.currentTime + 0.1);
      } catch (e) {
        console.log("Audio no soportado:", e);
      }
    }

    function cacheData(data) {
      const cache = {
        data: data,
        timestamp: Date.now(),
        version: CONFIG.VERSION
      };
      
      try {
        localStorage.setItem('pdaScannerCache', JSON.stringify(cache));
      } catch (e) {
        console.error("Error al guardar en cache:", e);
        if (e.name === 'QuotaExceededError') {
          clearOldCache();
          cacheData(data);
        }
      }
    }

    function updateUIWithCachedData(cachedData) {
      const lastUpdated = new Date(cachedData.timestamp).toLocaleString();
      statusDiv.textContent = "SISTEMA LISTO";
      dataStats.textContent = `${cachedData.data.length} registros (última actualización: ${lastUpdated})`;
      resultsDiv.innerHTML = '<div class="loading">Escanea un código para comenzar</div>';
    }

    function setupDataRefresh() {
      setInterval(() => {
        if (navigator.onLine) {
          fetchData();
        }
      }, 60 * 60 * 1000); // Actualizar cada hora
    }

    function clearOldCache() {
      // Eliminar datos antiguos para liberar espacio
      const keys = Object.keys(localStorage);
      for (const key of keys) {
        if (key.startsWith('pdaScannerCache')) {
          localStorage.removeItem(key);
        }
      }
    }
  </script>
</body>
</html>
